<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8" />
    <title>タイピングアプリ</title>
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <p id="count">60</p>
    <div id="wrap">
        <p id="text"></p>
    </div>
    <div id="start">
        <div class="btn">はじめる</div>
    </div>

    <script>
        // 必要なHTML要素の取得
        const wrap = document.getElementById('wrap');
        const start = document.getElementById('start');

        // 複数のテキストを格納する配列
        const textLists = [
            'Hello World', 'This is my App', 'How are you?',
            'Today is sunny', 'I love JavaScript!', 'Good morning',
            'I am Japanese', 'Let it be', 'Samurai',
            'Typing Game', 'Information Technology',
            'I want to be a programmer', 'What day is today?',
            'I want to build a web app', 'Nice to meet you',
            'Chrome Firefox Edge Safari', 'machine learning',
            'Brendan Eich', 'John Resig', 'React Vue Angular',
            'Netscape Communications', 'undefined null NaN',
            'Thank you very much', 'Google Apple Facebook Amazon',
            'ECMAScript', 'console.log', 'for while if switch',
            'var let const', 'Windows Mac Linux iOS Android',
            'programming', 'Wap And Peace'
        ];

        let checkTexts = [];
        let score = 0;

        //タイピング用文字列生成のメソッド
        const createText = () => {
            const p = document.getElementById('text');
            //配列のインデックス数からランダムな数値を生成する
            const rnd = Math.floor(Math.random() * textLists.length);

            //p要素を空に
            p.textContent = "";

            //テキストを1文字ずつ分解してp要素に挿入
            checkTexts = textLists[rnd].split("").map(value => {
                //span要素を生成
                const span = document.createElement("span");

                //span要素に配列を1文字ずつ当てはめる
                span.textContent = value;

                //spanをpに追加
                p.appendChild(span);

                //1文字ずつcheckTextに格納
                return span;
            })
        };

        //キー入力判定用のメソッド
        const keyDown = e => {
            if (e.key === checkTexts[0].textContent) {
                wrap.style.backgroundColor = '#666';
                checkTexts[0].className = "add-color";

                checkTexts.shift();

                //正しい入力の時にのみスコアを加算
                score++;

                if (!checkTexts.length) createText();
                //Shiftキーは除外
            } else if (e.key === 'Shift') {
                e.Handled = true;
                //タイプミスした場合は背景色を赤色に
            } else {
                wrap.style.backgroundColor = 'red';
            }
        };

        //タイマーのメソッド
        const timer = () => {

            //タイマー要素を取得
            const count = document.getElementById("count");

            //タイマーの初期値を設定
            let time = parseInt(count.textContent, 10);

            const id = setInterval(() => {
                //カウントが0になったらタイマーを停止
                if (time < 0) gameOver(id);

                if (time <= 10)
                    count.style.color = "red";

                //タイマーの表示を1ずつ減らしていく
                count.textContent = time--;

            }, 1000);
        };

        //ゲーム終了のメソッド
        const gameOver = id => {
            clearInterval(id);

            //スコアの値をrankCheck()に渡して結果を表示
            const result = confirm(rankCheck(score));

            if (result) window.location.reload();
            if (!result) window.location.reload();
        };

        //スコア表示用のメソッド
        const rankCheck = score => {
            //テキスト用変数
            let text = "";

            //スコアに応じてメッセージをtextに格納  
            if (score < 100) {
                text = `あなたのランクはCです。\nBランクまであと${100 - score}文字です。`;
            } else if (score < 200) {
                text = `あなたのランクはBです。\nAランクまであと${200 - score}文字です。`;
            } else if (score < 300) {
                text = `あなたのランクはAです。\nSランクまであと${300 - score}文字です。`;
            } else if (score >= 300) {
                text = `あなたのランクはSです。\nおめでとうございます!`;
            }
            //スコアの値を返す
            return `${score}文字打てました!\n${text}\n【OK】リトライ/【キャンセル】終了`;
        }

        //ゲーム開始の処理
        start.addEventListener("click", () => {
            countDown = new Promise((resolve) =>{
                startGame();
            })
        });

        //カウントダウンの処理
        const countDown = () => {
                let p = document.getElementById('text');

                p.textContent = 3;

                const intervalId = setInterval(() => {

                    p.textContent--;

                    if (p.textContent < 1){
                        clearInterval(intervalId);
                        resolve();
                    }

                }, 1000)
            }

        //ゲームスタートの処理
        const startGame = () => {
            //タイマー関数
            timer();

            //ランダムにテキストを表示
            createText();

            //スタートボタンを非表示に
            start.style.display = "none";

            //キーボードのイベント処理
            document.addEventListener("keydown", keyDown);
        }
    </script>
</body>

</html>